<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ingat-In Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      header p {
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
      }

      .stat-card h3 {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .stat-card .percentage {
        color: #667eea;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .users-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .users-section h2 {
        margin-bottom: 20px;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
      }

      .refresh-btn:hover {
        background: #5568d3;
      }

      .users-table {
        width: 100%;
        border-collapse: collapse;
        overflow-x: auto;
        display: block;
      }

      .users-table table {
        width: 100%;
      }

      .users-table th,
      .users-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .users-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
        position: sticky;
        top: 0;
      }

      .users-table tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .badge.success {
        background: #d4edda;
        color: #155724;
      }

      .badge.warning {
        background: #fff3cd;
        color: #856404;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        header h1 {
          font-size: 1.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .users-table {
          font-size: 0.9rem;
        }

        .users-table th,
        .users-table td {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üìä Ingat-In Dashboard</h1>
        <p>Monitoring Absensi WhatsApp Bot</p>
      </header>

      <div id="error-message"></div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Users</h3>
          <div class="value" id="total-users">-</div>
        </div>

        <div class="stat-card">
          <h3>Absen Pagi</h3>
          <div class="value" id="absen-pagi">-</div>
          <div class="percentage" id="pagi-percentage">-%</div>
        </div>

        <div class="stat-card">
          <h3>Absen Sore</h3>
          <div class="value" id="absen-sore">-</div>
          <div class="percentage" id="sore-percentage">-%</div>
        </div>
      </div>

      <div class="users-section">
        <h2>
          <span>Daftar Users</span>
          <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
        </h2>

        <div id="users-content" class="loading">Loading data...</div>
      </div>
    </div>

    <script>
      async function loadData() {
        try {
          // Clear error
          document.getElementById("error-message").innerHTML = "";

          // Load stats
          const statsRes = await fetch("/api/stats");
          const statsData = await statsRes.json();

          if (statsData.success) {
            document.getElementById("total-users").textContent = statsData.data.totalUsers;
            document.getElementById(
              "absen-pagi"
            ).textContent = `${statsData.data.absenPagi.sudah}/${statsData.data.totalUsers}`;
            document.getElementById(
              "pagi-percentage"
            ).textContent = `${statsData.data.absenPagi.percentage}%`;
            document.getElementById(
              "absen-sore"
            ).textContent = `${statsData.data.absenSore.sudah}/${statsData.data.totalUsers}`;
            document.getElementById(
              "sore-percentage"
            ).textContent = `${statsData.data.absenSore.percentage}%`;
          }

          // Load users
          const usersRes = await fetch("/api/users");
          const usersData = await usersRes.json();

          const usersContent = document.getElementById("users-content");

          if (usersData.success && usersData.data.length > 0) {
            usersContent.innerHTML = `
                        <div class="users-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nomor WhatsApp</th>
                                        <th>Absen Pagi</th>
                                        <th>Absen Sore</th>
                                        <th>Last Check-in</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${usersData.data
                                      .map(
                                        (user, idx) => `
                                        <tr>
                                            <td>${idx + 1}</td>
                                            <td>${user.number}</td>
                                            <td>
                                                <span class="badge ${
                                                  user.absen_pagi ? "success" : "warning"
                                                }">
                                                    ${user.absen_pagi ? "‚úì Sudah" : "‚úó Belum"}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${
                                                  user.absen_sore ? "success" : "warning"
                                                }">
                                                    ${user.absen_sore ? "‚úì Sudah" : "‚úó Belum"}
                                                </span>
                                            </td>
                                            <td>${
                                              user.last_checkin
                                                ? new Date(user.last_checkin).toLocaleString(
                                                    "id-ID"
                                                  )
                                                : "-"
                                            }</td>
                                        </tr>
                                    `
                                      )
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    `;
          } else {
            usersContent.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <h3>Belum ada user yang terdaftar</h3>
                            <p>User akan muncul setelah mengirim pesan ke bot</p>
                        </div>
                    `;
          }
        } catch (error) {
          document.getElementById("error-message").innerHTML = `
                    <div class="error">
                        ‚ö†Ô∏è Gagal memuat data: ${error.message}
                    </div>
                `;
        }
      }

      // Load data on page load
      loadData();

      // Auto refresh every 30 seconds
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
